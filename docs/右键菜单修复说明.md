# 右键菜单修复说明

## 修复时间
2025-11-17

## 问题描述
用户反馈右键菜单不显示。在 Electron 版本中,右键菜单使用的是原生的上下文菜单(通过 `ipcRenderer.send('show-context-menu')` 调用主进程),但在 Tauri 版本中这个功能还没有实现。

## 解决方案

### 1. 前端实现

#### 1.1 添加 HTML 容器
在 `src/index.html` 中添加了右键菜单的容器:

```html
<!-- 右键菜单 -->
<div id="context-menu" class="context-menu" style="display: none;">
    <!-- 菜单项将通过 JS 动态生成 -->
</div>
```

#### 1.2 实现菜单逻辑
在 `src/renderer-tauri.js` 中实现了以下函数:

**主要函数:**
- `showContextMenu(file, x, y)` - 显示右键菜单
- `hideContextMenu()` - 隐藏右键菜单
- `toggleFavorite(path)` - 切换收藏夹状态
- `openInExplorer(path)` - 在资源管理器中打开
- `renameFilePrompt(file)` - 重命名文件提示框
- `deleteFile(file)` - 删除文件

**菜单项配置:**
- 文件/文件夹右键菜单:
  - 打开
  - 在资源管理器中打开
  - 添加/取消收藏
  - 复制 (Ctrl+C)
  - 剪切 (Ctrl+X)
  - 删除 (Del)
  - 重命名

- 空白区域右键菜单:
  - 新建文件夹
  - 粘贴 (Ctrl+V)
  - 添加/取消收藏
  - 刷新 (F5)

**事件绑定:**
在 `bindEvents()` 函数中添加了:
```javascript
// 点击文档关闭右键菜单
document.addEventListener('click', hideContextMenu);

// 文件列表空白区域右键菜单
fileListContainer.addEventListener('contextmenu', (e) => {
    if (e.target === fileListContainer || e.target === fileList) {
        e.preventDefault();
        showContextMenu(null, e.clientX, e.clientY);
    }
});
```

在 `createFileItem()` 中,文件项已经有右键菜单事件:
```javascript
fileItem.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    showContextMenu(file, e.clientX, e.clientY);
});
```

#### 1.3 添加样式
创建了 `src/scss/components/_context-menu.sass`:

```sass
.context-menu
  position: fixed
  background: var(--bg-primary)
  border: 1px solid var(--border-color)
  border-radius: 4px
  padding: 4px 0
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15)
  z-index: 10000
  min-width: 180px
  max-width: 300px

  .context-menu-item
    padding: 8px 12px
    cursor: pointer
    display: flex
    justify-content: space-between
    align-items: center
    color: var(--text-primary)
    font-size: 14px
    transition: background-color 0.2s

    &:hover:not(.disabled)
      background: var(--hover-bg)

    &.disabled
      color: var(--text-disabled)
      cursor: not-allowed
      opacity: 0.5

    .context-menu-shortcut
      margin-left: 20px
      color: var(--text-secondary)
      font-size: 12px

  .context-menu-separator
    height: 1px
    background: var(--border-color)
    margin: 4px 0
```

并在 `src/scss/styles.sass` 中导入:
```sass
@use 'components/_context-menu'
```

### 2. 后端实现

在 `src-tauri/src/main.rs` 中添加了以下命令:

```rust
// 连接路径
#[tauri::command]
async fn join_path(base: String, path: String) -> Result<String, String> {
    let base_path = Path::new(&base);
    let joined = base_path.join(path);
    Ok(joined.to_string_lossy().to_string())
}

// 删除目录
#[tauri::command]
async fn remove_directory(path: String) -> Result<(), String> {
    fs::remove_dir_all(path).map_err(|e| e.to_string())
}

// 删除文件
#[tauri::command]
async fn remove_file(path: String) -> Result<(), String> {
    fs::remove_file(path).map_err(|e| e.to_string())
}

// 在资源管理器中打开（别名）
#[tauri::command]
async fn open_in_explorer(path: String) -> Result<(), String> {
    show_in_explorer(path).await
}
```

并在 `invoke_handler` 中注册这些命令:
```rust
.invoke_handler(tauri::generate_handler![
    // ... 其他命令
    join_path,
    remove_directory,
    remove_file,
    open_in_explorer,
])
```

## 功能特性

### 1. 智能菜单项
- 根据文件类型和上下文动态显示菜单项
- 禁用状态的菜单项会显示为灰色且不可点击
- 显示快捷键提示

### 2. 位置智能调整
- 菜单会自动避免超出屏幕边界
- 在鼠标点击位置显示,体验流畅

### 3. 主题支持
- 支持亮色和暗色主题
- 使用 CSS 变量,自动适配当前主题

### 4. 点击外部关闭
- 点击菜单外的任何位置都会自动关闭菜单
- 执行菜单操作后自动关闭

## 测试建议

1. **文件/文件夹右键菜单**:
   - 右键点击文件列表中的文件/文件夹
   - 验证所有菜单项是否正常显示
   - 测试每个菜单项的功能

2. **空白区域右键菜单**:
   - 在文件列表的空白区域右键点击
   - 验证菜单项是否正确(新建文件夹、粘贴、刷新等)

3. **菜单关闭**:
   - 点击菜单外的区域,验证菜单是否自动关闭
   - 执行菜单操作后,验证菜单是否自动关闭

4. **主题切换**:
   - 在亮色和暗色主题下测试菜单样式
   - 验证颜色和对比度是否合适

5. **边界情况**:
   - 在屏幕右边缘和底部边缘右键点击
   - 验证菜单是否自动调整位置,不会超出屏幕

## 已知问题

暂无

## 后续优化

1. 可以考虑添加图标到菜单项
2. 可以添加子菜单支持
3. 可以添加菜单项分组的视觉效果
4. 考虑添加键盘导航支持(方向键选择菜单项)

