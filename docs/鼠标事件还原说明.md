# 鼠标事件还原说明

## 概述
已成功将原 Electron 版本中的鼠标滚轮事件和双击返回事件迁移到 Tauri 版本。

## 已还原的事件

### 1. 日历视图滚轮事件 🖱️

**功能描述**：
- 在日历视图的控件区域使用鼠标滚轮可以快速切换月份
- 向上滚动：切换到上一个月
- 向下滚动：切换到下一个月
- 滚动时有视觉反馈（切换动画）

**使用方法**：
1. 进入日历视图
2. 将鼠标悬停在日历控件区域（显示年月的标题栏）
3. 滚动鼠标滚轮即可快速切换月份

**技术实现**：
```javascript
// 为日历控件添加滚轮事件监听
const calendarControls = document.getElementById('calendar-controls');
if (calendarControls) {
    calendarControls.addEventListener('wheel', handleCalendarScroll);
}

// 处理日历滚轮事件
function handleCalendarScroll(e) {
    e.preventDefault(); // 防止页面滚动
    const delta = e.deltaY < 0 ? -1 : 1;
    
    // 添加视觉反馈
    const calendarGrid = document.querySelector('.calendar-grid');
    if (calendarGrid) {
        calendarGrid.classList.add('switching');
        setTimeout(() => {
            calendarGrid.classList.remove('switching');
        }, 300);
    }
    
    changeMonth(delta);
}
```

---

### 2. 双击空白处返回上一级 ⬆️

**功能描述**：
- 在文件列表的空白区域双击可以返回上一级目录
- 如果是从日历视图跳转进入的文件夹，双击返回日历视图
- 智能判断导航上下文

**使用方法**：
1. 在文件浏览界面，双击文件列表的空白区域
2. 系统会自动返回上一级目录
3. 如果是从日历跳转的，会返回日历视图

**技术实现**：
```javascript
// 文件列表容器双击事件
const fileListContainer = document.getElementById('file-list-container');
const fileList = document.getElementById('file-list');

if (fileListContainer) {
    fileListContainer.addEventListener('dblclick', (e) => {
        if (e.target === fileListContainer || e.target === fileList) {
            if (isFromCalendar) {
                // 如果是从日历视图跳转来的，返回日历视图
                isFromCalendar = false; // 重置标记
                showCalendarView();
            } else {
                // 正常的向上导航逻辑
                const parentPath = path.dirname(currentPath);
                if (parentPath !== currentPath) {
                    navigateTo(parentPath);
                }
            }
        }
    });
}
```

---

### 3. 从日历跳转的智能导航 🧭

**功能描述**：
- 从日历视图双击文件夹进入后，系统会记住来源
- 点击"向上"按钮时，会返回日历视图而不是上级目录
- 双击空白处也会返回日历视图
- 自动重置标记，避免混淆导航状态

**使用方法**：
1. 在日历视图中双击某个项目文件夹
2. 进入该文件夹后，点击"向上"按钮或双击空白处
3. 系统会返回日历视图，而不是文件夹的上级目录

**技术实现**：

**设置标记**：
```javascript
// 日历视图中的文件夹双击事件
document.querySelectorAll('.folder-item').forEach(item => {
    item.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        const folderPath = item.getAttribute('data-path');
        if (folderPath) {
            isFromCalendar = true; // 设置标记，表示从日历跳转
            navigateTo(folderPath);
        }
    });
});
```

**检查标记并导航**：
```javascript
async function navigateUp() {
    if (isFromCalendar) {
        // 如果是从日历视图跳转来的，返回日历视图
        isFromCalendar = false; // 重置标记
        showCalendarView();
        return;
    }
    
    const parentPath = path.dirname(currentPath);
    if (parentPath && parentPath !== currentPath) {
        await navigateTo(parentPath);
    }
}
```

---

## 代码位置

### 前端代码
- **文件**：`src/renderer-tauri.js`
- **相关变量**：
  - `isFromCalendar` - 标记是否从日历跳转（行 34）
  
- **相关函数**：
  - `handleCalendarScroll(e)` - 处理日历滚轮事件（行 851-865）
  - `navigateUp()` - 向上导航（已更新，行 198-210）
  - `bindEvents()` - 绑定事件监听器（已更新，添加双击事件）

---

## 事件优先级和冒泡

### 事件冒泡处理
所有交互事件都正确处理了事件冒泡：

1. **文件夹项双击事件**：
   - 使用 `e.stopPropagation()` 阻止事件冒泡
   - 避免触发容器的双击事件

2. **空白区域双击事件**：
   - 只在 `e.target` 是容器元素本身时触发
   - 不会被子元素的事件触发

3. **滚轮事件**：
   - 使用 `e.preventDefault()` 阻止默认滚动
   - 只在日历控件区域有效

---

## 用户体验改进

### 1. 视觉反馈
- 滚轮切换月份时，日历网格添加 `.switching` 类
- 可以通过 CSS 添加平滑过渡动画
- 持续 300ms 的视觉反馈

### 2. 智能导航
- 系统记住用户的导航路径
- 从日历进入的文件夹，返回时回到日历
- 正常浏览时，返回上级目录
- 避免用户迷失在目录结构中

### 3. 多种返回方式
用户可以通过多种方式返回：
- 点击"向上"按钮（工具栏）
- 双击文件列表空白处
- 使用快捷键（如果已实现）

---

## 注意事项

### 1. 滚轮事件作用范围
- 滚轮事件只在日历控件区域有效
- 在日历网格区域滚动仍然是正常的页面滚动
- 这样避免了与页面滚动冲突

### 2. 双击判断
- 双击事件只在点击容器本身时触发
- 点击文件或文件夹不会触发返回
- 需要点击完全的空白区域

### 3. 状态管理
- `isFromCalendar` 标记在返回后会被重置
- 避免连续多次返回到日历
- 确保导航逻辑清晰

---

## 测试建议

### 测试滚轮事件
1. 进入日历视图
2. 在日历标题栏区域滚动鼠标滚轮
3. 确认月份正确切换
4. 观察是否有视觉反馈

### 测试双击返回
1. 在普通文件夹中，双击空白处
2. 确认返回上级目录
3. 从日历进入文件夹
4. 双击空白处，确认返回日历视图

### 测试智能导航
1. 从日历双击进入文件夹
2. 点击"向上"按钮
3. 确认返回日历而不是上级目录
4. 再次进入文件夹（通过正常浏览）
5. 点击"向上"按钮
6. 确认返回上级目录

---

## 可能的扩展

### 1. 快捷键支持
可以添加键盘快捷键来执行相同操作：
- `Backspace` - 返回上一级
- `Alt + ←` - 后退
- `Alt + ↑` - 向上

### 2. 鼠标手势
可以添加鼠标手势支持：
- 右键拖动向左 - 后退
- 右键拖动向上 - 向上

### 3. 更多滚轮功能
- 在年报视图使用滚轮切换年份
- 在文件列表按住 Ctrl 滚轮缩放图标大小

---

## 更新日志

**2025-11-17**
- ✅ 添加日历视图滚轮事件
- ✅ 添加双击空白处返回上一级
- ✅ 实现从日历跳转的智能导航
- ✅ 添加视觉反馈和动画
- ✅ 完善事件冒泡处理

---

## 相关文档
- [功能还原说明.md](./功能还原说明.md) - 日历和年报功能详细说明
- [功能测试指南.md](./功能测试指南.md) - 完整的测试流程


