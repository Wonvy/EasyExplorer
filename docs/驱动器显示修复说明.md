# 驱动器显示修复说明

## 更新时间
2025-01-17

## 修复的问题

### 1. 网络驱动器不显示

**问题描述：**
- 之前只使用 `sysinfo` 库获取驱动器
- `sysinfo` 在Windows上无法枚举网络驱动器
- 只能看到本地磁盘，看不到映射的网络驱动器

**解决方案：**
- 在Windows上使用 `wmic` 命令获取所有逻辑磁盘
- `wmic` 可以枚举所有类型的驱动器，包括网络驱动器
- 结合 `sysinfo` 获取详细的磁盘空间信息
- 如果 `sysinfo` 无法获取（如网络驱动器），则从 `wmic` 输出中解析

**技术实现：**

```rust
// 使用 wmic 获取所有驱动器
let output = Command::new("wmic")
    .args(&["logicaldisk", "get", "name,volumename,size,freespace,drivetype,filesystem", "/format:csv"])
    .output()
    .map_err(|e| e.to_string())?;
```

**wmic DriveType 映射：**
- `2` - Removable（可移动磁盘，如U盘）
- `3` - HDD/SSD（本地磁盘）
- `4` - Network（网络驱动器）
- `5` - CD-ROM（光盘驱动器）

---

### 2. 驱动器顺序混乱

**问题描述：**
- 驱动器显示顺序不固定
- 可能显示为 D:\, C:\, E:\ 等乱序
- 用户期望按字母顺序显示（C:\ → D:\ → E:\ ...）

**解决方案：**
- 在返回驱动器列表前进行排序
- 使用 Rust 的 `sort_by` 方法按名称排序
- 确保 C 盘始终在第一位

**技术实现：**

```rust
// 按驱动器名称排序（C:\ < D:\ < E:\ ...）
drives.sort_by(|a, b| a.name.cmp(&b.name));
```

---

## 支持的驱动器类型

### 1. HDD（机械硬盘）
- **图标**: `fa-hdd` 💿
- **颜色**: 蓝色 (#4a90e2)
- **说明**: 传统机械硬盘

### 2. SSD（固态硬盘）
- **图标**: `fa-microchip` 🖥️
- **颜色**: 紫色 (#9b59b6)
- **说明**: 固态硬盘

### 3. Network（网络驱动器）
- **图标**: `fa-network-wired` 🌐
- **颜色**: 绿色 (#27ae60)
- **说明**: 映射的网络驱动器

### 4. Removable（可移动磁盘）
- **图标**: `fa-usb` 🔌
- **颜色**: 橙色 (#e67e22)
- **说明**: U盘、移动硬盘等

### 5. CD-ROM（光盘驱动器）
- **图标**: `fa-compact-disc` 💿
- **颜色**: 灰色 (#95a5a6)
- **说明**: CD/DVD 光驱

---

## 显示信息

每个驱动器卡片显示以下信息：

### 标题栏
- **驱动器名称**：如 C:\, D:\, Z:\（网络驱动器）
- **可用空间/总容量**：如 "50.5 GB 可用 / 100 GB"

### 卷标
- 显示自定义卷标名称
- 如果没有卷标，显示默认名称：
  - 本地磁盘 (C:)
  - 网络驱动器 (Z:)
  - 可移动磁盘 (E:)

### 进度条
- 可视化显示磁盘使用情况
- 颜色根据使用率变化：
  - **蓝色**：正常 (< 60%)
  - **橙色**：警告 (60-70%)
  - **红色**：危险 (> 70%)

### 悬停提示
鼠标悬停时显示详细信息：
- 卷标名称
- 驱动器类型（HDD/SSD/Network等）
- 文件系统（NTFS, FAT32等）
- 总容量
- 已使用空间（百分比）
- 可用空间

---

## 测试网络驱动器

### 创建测试环境

#### 方法1：映射网络驱动器（推荐）
1. 打开"此电脑"
2. 点击"映射网络驱动器"
3. 选择驱动器号（如 Z:）
4. 输入网络路径（如 `\\服务器\共享文件夹`）
5. 点击"完成"

#### 方法2：使用命令行
```bash
# 映射网络驱动器
net use Z: \\服务器\共享文件夹

# 查看所有映射
net use

# 断开映射
net use Z: /delete
```

#### 方法3：使用本地共享（测试用）
1. 创建一个文件夹并共享
2. 映射自己的共享文件夹到一个驱动器号
3. 测试应用是否正确显示

---

## 兼容性说明

### Windows
- ✅ 完全支持所有类型的驱动器
- ✅ 使用 `wmic` 命令（Windows内置）
- ✅ 自动识别驱动器类型

### Linux/macOS
- ✅ 支持本地磁盘
- ⚠️ 网络驱动器识别有限（取决于挂载方式）
- ℹ️ 使用 `sysinfo` 库获取信息

---

## 已知限制

1. **网络驱动器性能**：
   - 网络驱动器的空间查询可能较慢
   - 如果网络不可达，可能导致获取超时

2. **特殊驱动器**：
   - 某些虚拟驱动器（如 RAM Disk）可能显示为"Unknown"
   - 加密卷可能需要解锁后才能正确显示

3. **权限限制**：
   - 某些受保护的驱动器可能无法访问
   - 需要管理员权限的驱动器会显示但可能无法打开

---

## 故障排除

### 问题1：网络驱动器不显示

**可能原因**：
- 网络连接断开
- 驱动器未正确映射
- 权限不足

**解决方法**：
1. 检查网络连接
2. 在"此电脑"中确认驱动器是否可见
3. 尝试重新映射网络驱动器
4. 重启应用

### 问题2：驱动器信息不准确

**可能原因**：
- 磁盘空间刚刚变化
- 缓存未更新

**解决方法**：
1. 点击刷新按钮（F5）
2. 重新导航到其他目录再返回
3. 重启应用

### 问题3：某些驱动器显示为"Unknown"

**可能原因**：
- 特殊类型的虚拟驱动器
- wmic 无法识别的类型

**解决方法**：
- 这是正常现象
- 功能不受影响，仍可正常访问

---

## 代码变更

### 修改的文件

#### src-tauri/src/main.rs
```rust
// 新增：使用 wmic 获取所有驱动器
#[cfg(target_os = "windows")]
{
    use std::process::Command;
    
    let output = Command::new("wmic")
        .args(&["logicaldisk", "get", "name,volumename,size,freespace,drivetype,filesystem", "/format:csv"])
        .output()
        .map_err(|e| e.to_string())?;
    
    // 解析 wmic 输出
    // ...
    
    // 按名称排序
    drives.sort_by(|a, b| a.name.cmp(&b.name));
}
```

#### src/renderer-tauri.js
```javascript
// 新增：更多驱动器类型的图标支持
switch(drive.drive_type) {
    case 'Network':
        driveIcon = 'fa-network-wired';
        iconColor = '#27ae60';
        break;
    case 'Removable':
        driveIcon = 'fa-usb';
        iconColor = '#e67e22';
        break;
    case 'CD-ROM':
        driveIcon = 'fa-compact-disc';
        iconColor = '#95a5a6';
        break;
    // ...
}
```

---

## 测试清单

- [x] C盘显示在第一位
- [x] 驱动器按字母顺序排列
- [x] 本地磁盘正确显示类型和图标
- [ ] 网络驱动器正确显示（需要实际环境测试）
- [x] U盘插入后正确显示为"Removable"
- [x] 驱动器点击可以正常打开
- [x] 悬停显示详细信息
- [x] 进度条颜色根据使用率正确变化
- [x] 暗色主题下显示正常

---

## 后续优化建议

1. **性能优化**：
   - 缓存驱动器列表
   - 异步加载网络驱动器信息
   - 添加加载状态指示器

2. **功能增强**：
   - 右键菜单支持驱动器操作
   - 添加"刷新驱动器列表"按钮
   - 显示驱动器健康状态（SMART）

3. **用户体验**：
   - 添加驱动器搜索功能
   - 支持自定义驱动器排序
   - 驱动器分组显示（本地/网络/可移动）

---

## 相关文档
- [功能修复和增强说明.md](./功能修复和增强说明.md)
- [Tauri 文件系统API文档](https://tauri.app/v1/api/js/fs)
- [Windows WMIC 命令参考](https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmic)






