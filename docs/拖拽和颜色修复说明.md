# 拖拽和颜色修复说明

## 修复时间
2025-11-17

## 问题描述

用户反馈两个问题:
1. **驱动器和收藏夹颜色不对**: 图标颜色不够醒目
2. **无法拖拽调整左右两栏宽度**: 按住鼠标拖拽分隔线时没有反应

## 解决方案

### 1. 实现拖拽调整功能

在 `src/renderer-tauri.js` 中添加了完整的拖拽调整功能。

#### 添加的代码结构

```javascript
// 全局变量
let isResizing = false;
let isResizingPreview = false;

function initResizers() {
    // 左侧边栏拖拽
    resizer.addEventListener('mousedown', (e) => {
        // 设置拖拽状态
        // 监听鼠标移动
        // 实时调整宽度
    });
    
    // 右侧预览面板拖拽
    previewResizer.addEventListener('mousedown', (e) => {
        // 设置拖拽状态
        // 监听鼠标移动
        // 实时调整宽度
    });
    
    // 侧边栏切换按钮
    sidebarToggle.addEventListener('click', () => {
        // 展开/折叠侧边栏
    });
    
    // 预览面板切换按钮
    previewToggle.addEventListener('click', () => {
        // 展开/折叠预览面板
    });
}
```

#### 左侧边栏拖拽实现

```javascript
resizer.addEventListener('mousedown', (e) => {
    e.preventDefault();
    isResizing = true;
    resizer.classList.add('resizing');
    document.body.style.userSelect = 'none';
    document.body.style.cursor = 'col-resize';
    
    const onMouseMove = (e) => {
        if (!isResizing) return;
        requestAnimationFrame(() => {
            const newWidth = e.clientX;
            if (newWidth > 150 && newWidth < window.innerWidth * 0.4) {
                sidebar.style.width = `${newWidth}px`;
                if (newWidth < 350) {
                    sidebar.classList.add('small-width');
                } else {
                    sidebar.classList.remove('small-width');
                }
            }
        });
    };
    
    const onMouseUp = () => {
        isResizing = false;
        resizer.classList.remove('resizing');
        document.body.style.userSelect = '';
        document.body.style.cursor = '';
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    };
    
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
});
```

**特性:**
- ✅ 最小宽度限制: 150px
- ✅ 最大宽度限制: 窗口宽度的 40%
- ✅ 小窗口模式: 宽度 < 350px 时自动切换到简化视图
- ✅ 性能优化: 使用 `requestAnimationFrame` 优化渲染
- ✅ 防止文字选中: 拖拽时禁用 `userSelect`
- ✅ 光标提示: 拖拽时显示 `col-resize` 光标

#### 右侧预览面板拖拽实现

```javascript
previewResizer.addEventListener('mousedown', (e) => {
    e.preventDefault();
    isResizingPreview = true;
    previewResizer.classList.add('resizing');
    document.body.style.userSelect = 'none';
    document.body.style.cursor = 'col-resize';
    
    const onMouseMove = (e) => {
        if (!isResizingPreview) return;
        requestAnimationFrame(() => {
            const newWidth = window.innerWidth - e.clientX;
            if (newWidth > 200 && newWidth < window.innerWidth * 0.5) {
                previewPanel.style.width = `${newWidth}px`;
            }
        });
    };
    
    const onMouseUp = () => {
        isResizingPreview = false;
        previewResizer.classList.remove('resizing');
        document.body.style.userSelect = '';
        document.body.style.cursor = '';
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    };
    
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
});
```

**特性:**
- ✅ 最小宽度限制: 200px
- ✅ 最大宽度限制: 窗口宽度的 50%
- ✅ 从右向左计算宽度
- ✅ 性能优化和用户体验优化与左侧相同

#### 侧边栏和预览面板切换

```javascript
// 侧边栏切换
sidebarToggle.addEventListener('click', () => {
    if (sidebar.classList.contains('collapsed')) {
        sidebar.classList.remove('collapsed');
        sidebar.style.width = '250px';
    } else {
        sidebar.classList.add('collapsed');
        sidebar.style.width = '0';
    }
});

// 预览面板切换
previewToggle.addEventListener('click', () => {
    if (previewPanel.classList.contains('collapsed')) {
        previewPanel.classList.remove('collapsed');
        previewPanel.style.width = '300px';
    } else {
        previewPanel.classList.add('collapsed');
        previewPanel.style.width = '0';
    }
});
```

**特性:**
- ✅ 一键展开/折叠
- ✅ 默认宽度设置(侧边栏 250px, 预览 300px)
- ✅ 流畅的过渡动画(通过 CSS transition)

### 2. 修复驱动器和收藏夹颜色

在 `src/scss/components/_sidebar.sass` 中为图标添加了明确的颜色定义。

#### 驱动器图标颜色

```sass
#drives
  .drive-item
    .file-icon
      color: #4a90e2  // 蓝色
```

**亮色主题:**
- 颜色: #4a90e2 (蓝色)
- 含义: 代表系统驱动器

**暗色主题:**
```sass
body.dark-theme, [data-theme="dark"]
  #sidebar
    #drives
      .drive-item
        .file-icon
          color: #5ba3ef  // 浅蓝色
```

#### 收藏夹图标颜色

```sass
#favorites
  .favorite-item
    .file-icon
      color: #f39c12  // 橙色/金色
```

**亮色主题:**
- 颜色: #f39c12 (金色)
- 含义: 代表收藏/星标项目

**暗色主题:**
```sass
body.dark-theme, [data-theme="dark"]
  #sidebar
    #favorites
      .favorite-item
        .file-icon
          color: #f5b041  // 浅金色
```

#### 颜色选择原因

1. **驱动器 (蓝色)**
   - 蓝色代表系统和技术
   - 与 Windows 资源管理器的驱动器图标风格一致
   - 醒目但不刺眼

2. **收藏夹 (金色)**
   - 金色/橙色代表重要性和收藏
   - 与常见的星标/收藏功能颜色一致
   - 在亮色和暗色主题下都很醒目

3. **暗色主题调整**
   - 颜色稍微变浅,提高对比度
   - 保持与亮色主题一致的视觉语言
   - 确保可读性和视觉舒适度

## 文件变更清单

### JavaScript 修改
- `src/renderer-tauri.js`:
  - 添加 `initResizers()` 函数 (约 110 行)
  - 在 `initUI()` 中调用 `initResizers()`
  - 添加全局变量 `isResizing` 和 `isResizingPreview`

### 样式修改
- `src/scss/components/_sidebar.sass`:
  - 为 `#drives .drive-item .file-icon` 添加颜色
  - 为 `#favorites .favorite-item .file-icon` 添加颜色
  - 更新暗色主题的图标颜色

## 测试指南

### 拖拽功能测试

#### 左侧边栏拖拽
1. **基本拖拽**
   - 鼠标移动到左侧分隔线上
   - 光标应该变成 `col-resize` (双向箭头)
   - 按住鼠标左键并拖动
   - 侧边栏宽度应该实时变化

2. **宽度限制**
   - 尝试向左拖动到很窄
   - 验证最小宽度 (150px) 是否生效
   - 尝试向右拖动到很宽
   - 验证最大宽度 (窗口 40%) 是否生效

3. **小窗口模式**
   - 将侧边栏拖动到小于 350px
   - 验证是否自动切换到简化视图
   - 拖动回大于 350px
   - 验证是否恢复正常视图

4. **性能测试**
   - 快速来回拖动
   - 验证是否流畅,无卡顿
   - 检查 CPU 使用率

#### 右侧预览面板拖拽
1. **基本拖拽**
   - 鼠标移动到右侧分隔线上
   - 按住鼠标左键并拖动
   - 预览面板宽度应该实时变化

2. **宽度限制**
   - 验证最小宽度 (200px)
   - 验证最大宽度 (窗口 50%)

3. **方向测试**
   - 注意拖动方向与侧边栏相反
   - 向左拖动变窄,向右拖动变宽

#### 切换按钮测试
1. **侧边栏切换**
   - 点击侧边栏切换按钮
   - 验证侧边栏是否完全折叠
   - 再次点击验证是否恢复到 250px

2. **预览面板切换**
   - 点击预览面板切换按钮
   - 验证预览面板是否完全折叠
   - 再次点击验证是否恢复到 300px

### 颜色功能测试

#### 亮色主题
1. **驱动器图标**
   - 导航到主页选项卡
   - 查看驱动器列表
   - 验证驱动器图标是否为蓝色 (#4a90e2)
   - 图标应该醒目但不刺眼

2. **收藏夹图标**
   - 查看收藏夹列表
   - 验证收藏图标是否为金色 (#f39c12)
   - 颜色应该与驱动器有明显区分

#### 暗色主题
1. **切换到暗色主题**
   - 点击设置菜单中的"切换主题"
   - 或按快捷键切换主题

2. **驱动器图标**
   - 验证驱动器图标是否为浅蓝色 (#5ba3ef)
   - 检查颜色对比度
   - 确保在暗色背景下清晰可见

3. **收藏夹图标**
   - 验证收藏图标是否为浅金色 (#f5b041)
   - 检查颜色对比度
   - 确保与驱动器图标有明显区分

#### 可访问性测试
1. **对比度检查**
   - 使用对比度检查工具
   - 验证图标颜色与背景的对比度
   - 确保符合 WCAG 标准

2. **色盲友好性**
   - 检查颜色区分是否足够
   - 蓝色和金色应该对大多数色盲用户友好

## 预期效果

### 拖拽功能
- ✅ 鼠标悬停在分隔线上时光标变化
- ✅ 可以流畅地拖动调整宽度
- ✅ 有最小和最大宽度限制
- ✅ 拖拽时不会选中文字
- ✅ 释放鼠标后保持调整后的宽度
- ✅ 性能优良,无卡顿

### 图标颜色
- ✅ 驱动器图标显眼的蓝色
- ✅ 收藏夹图标显眼的金色
- ✅ 暗色主题下颜色自动调整
- ✅ 良好的视觉层次和区分度
- ✅ 符合常见设计规范

## 常见问题

### 问题1: 拖拽时有卡顿
**原因**: 可能是其他进程占用 CPU
**解决**: 
- 关闭不必要的程序
- 检查是否有大量文件渲染
- 使用性能分析工具检查

### 问题2: 拖拽后宽度跳变
**原因**: 可能是宽度限制触发
**解决**: 
- 检查是否达到最小/最大宽度限制
- 调整限制值以适应需求

### 问题3: 颜色不显示
**原因**: CSS 未正确编译或加载
**解决**:
```bash
# 重新编译 SCSS
npm run sass:build

# 清除浏览器缓存
Ctrl + Shift + Delete

# 重启开发服务器
npm run dev
```

### 问题4: 暗色主题下颜色太浅
**调整**: 修改 `src/scss/components/_sidebar.sass` 中的颜色值:
```sass
body.dark-theme, [data-theme="dark"]
  #sidebar
    #drives
      .drive-item
        .file-icon
          color: #6bb3ff  // 可以调整为更亮的蓝色
```

## 技术细节

### 性能优化
1. **使用 requestAnimationFrame**
   - 避免强制同步布局
   - 确保在浏览器重绘周期内更新
   - 减少 CPU 使用率

2. **事件监听器管理**
   - 拖拽结束后立即移除监听器
   - 避免内存泄漏
   - 提高整体性能

3. **CSS 过渡**
   - 切换动画通过 CSS transition 实现
   - GPU 加速
   - 更流畅的视觉效果

### 用户体验
1. **视觉反馈**
   - 光标变化提示可拖拽
   - 拖拽时添加 `.resizing` 类
   - 可以通过 CSS 添加视觉效果

2. **防止误操作**
   - 拖拽时禁用文字选择
   - 合理的宽度限制
   - 平滑的动画过渡

3. **响应式**
   - 宽度限制基于窗口大小
   - 自动调整到合理范围
   - 小窗口模式自动触发

## 后续优化建议

1. **宽度记忆**
   - 使用 localStorage 保存用户调整的宽度
   - 下次打开应用时恢复

2. **双击重置**
   - 双击分隔线快速重置到默认宽度

3. **动画效果**
   - 为 `.resizing` 类添加视觉效果
   - 如蓝色高亮线

4. **更多颜色选项**
   - 允许用户自定义图标颜色
   - 提供颜色预设方案

5. **触摸支持**
   - 添加 touch 事件支持
   - 适配平板和触摸屏设备





