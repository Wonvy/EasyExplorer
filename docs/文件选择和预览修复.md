# 文件选择和预览功能修复

## 🐛 问题描述

### 问题 1: 文件单击无法保持高亮
- **现象**: 点击文件后高亮显示，再次点击同一文件高亮消失
- **原因**: `selectFile` 函数会切换选中状态，导致已选中的文件再次点击会取消选中
- **影响**: 用户体验差，无法保持文件选中状态

### 问题 2: 文件夹预览不显示
- **现象**: 点击文件夹时，右侧预览面板不显示文件夹内容列表
- **原因**: `selectFile` 函数没有调用 `updatePreview`，导致预览面板不更新
- **影响**: 无法快速查看文件夹内容

## ✅ 修复方案

### 修复 1: 改进文件选择逻辑

#### 旧逻辑（有问题）：
```javascript
function selectFile(file, multiSelect) {
    // ...
    const isCurrentlySelected = fileItem.classList.contains('selected');
    
    if (!multiSelect) {
        // 清除其他选中
        // ...
    }
    
    // 问题：无论单选还是多选，都会切换状态
    if (isCurrentlySelected) {
        fileItem.classList.remove('selected');  // ❌ 单击时会取消选中
    } else {
        fileItem.classList.add('selected');
    }
    // ❌ 没有调用 updatePreview
}
```

#### 新逻辑（已修复）：
```javascript
function selectFile(file, multiSelect) {
    // ...
    
    if (!multiSelect) {
        // 单击模式：总是选中点击的项
        document.querySelectorAll('.file-item.selected').forEach(item => {
            item.classList.remove('selected');
        });
        selectedFiles = [];
        
        fileItem.classList.add('selected');  // ✅ 直接选中，不切换
        selectedFiles.push(file.path);
        
        updatePreview(file.path);  // ✅ 更新预览
    } else {
        // 多选模式（Ctrl + 点击）：切换状态
        if (isCurrentlySelected) {
            fileItem.classList.remove('selected');
            // ...
        } else {
            fileItem.classList.add('selected');
            // ...
        }
        
        // 预览最后选中的文件
        if (selectedFiles.length > 0) {
            updatePreview(selectedFiles[selectedFiles.length - 1]);
        }
    }
}
```

### 修复 2: 恢复预览面板默认样式

#### 问题：
PDF 预览会修改 `previewContent` 的样式（移除 padding、设置 flex 布局），导致切换到其他文件时样式异常。

#### 解决方案：
```javascript
async function updatePreview(filePath) {
    const previewContent = document.getElementById('preview-content');
    if (!previewContent) return;
    
    // ✅ 恢复默认样式
    previewContent.style.padding = '';
    previewContent.style.display = '';
    previewContent.style.flexDirection = '';
    previewContent.style.height = '';
    
    // ... 其余预览逻辑
}
```

## 🎯 功能说明

### 单击行为（普通点击）
```
点击文件/文件夹
    ↓
清除其他选中项
    ↓
选中当前项（高亮显示）
    ↓
显示预览（文件内容或文件夹列表）
```

**效果**：
- ✅ 点击后始终保持高亮
- ✅ 再次点击同一项不会取消高亮
- ✅ 预览面板实时更新

### 多选行为（Ctrl + 点击）
```
Ctrl + 点击文件
    ↓
切换该项选中状态
    ↓
预览最后选中的项
```

**效果**：
- ✅ 可以选择多个文件
- ✅ 已选中的项再次点击会取消选中
- ✅ 预览显示最后操作的文件

## 📊 对比测试

### 修复前 ❌
| 操作 | 预期 | 实际 |
|-----|------|------|
| 点击文件 A | 高亮 + 预览 | 高亮，无预览 |
| 再次点击 A | 保持高亮 | 取消高亮 ❌ |
| 点击文件夹 B | 高亮 + 显示列表 | 高亮，无列表 ❌ |

### 修复后 ✅
| 操作 | 预期 | 实际 |
|-----|------|------|
| 点击文件 A | 高亮 + 预览 | ✅ 高亮 + 预览 |
| 再次点击 A | 保持高亮 | ✅ 保持高亮 + 预览 |
| 点击文件夹 B | 高亮 + 显示列表 | ✅ 高亮 + 显示列表 |
| Ctrl+点击 C | 多选 | ✅ 多选 + 预览 C |

## 🎨 视觉效果

### 文件选中
```
┌─────────────────────────┐
│  file1.txt              │
│  [file2.txt] ← 高亮     │ ← 点击后保持高亮
│  file3.pdf              │
└─────────────────────────┘
```

### 文件夹预览
```
┌──────────┬──────────────────┐
│ 文件列表 │  预览面板        │
├──────────┼──────────────────┤
│ 📁 Docs  │  📁 Documents    │
│          │  包含 25 个项目  │
│          │  ────────────    │
│          │  📄 file1.txt    │
│          │  📄 file2.doc    │
│          │  📁 subfolder    │
│          │  ...             │
└──────────┴──────────────────┘
```

## 🔍 代码改动总结

### 文件：`src/renderer-tauri.js`

#### 改动 1: `selectFile` 函数（第 797-842 行）
- 分离单选和多选逻辑
- 单选时不切换状态，直接选中
- 添加 `updatePreview` 调用

#### 改动 2: `updatePreview` 函数（第 846-859 行）
- 添加样式重置逻辑
- 确保从 PDF 预览切换时样式正常

## 💡 使用场景

### 场景 1: 浏览文件
1. 点击文件 → 高亮显示 + 右侧预览内容
2. 点击另一个文件 → 切换高亮 + 更新预览
3. 再次点击同一文件 → 保持高亮（不取消）

### 场景 2: 查看文件夹
1. 点击文件夹 → 高亮显示 + 右侧显示文件夹内容列表
2. 快速浏览文件夹包含哪些文件
3. 双击文件夹 → 进入文件夹

### 场景 3: 多选文件
1. 点击文件 A → 选中 A
2. Ctrl + 点击文件 B → 同时选中 A 和 B
3. Ctrl + 点击文件 A → 取消选中 A（只剩 B）
4. 预览面板显示 B 的内容

## 🐛 已知问题（已修复）

### ~~问题 1: 样式污染~~
- ~~现象~~: PDF 预览后，切换到其他文件，布局异常
- **修复**: 在 `updatePreview` 开头重置样式
- ✅ 已修复

### ~~问题 2: 多选预览混乱~~
- ~~现象~~: 多选时不知道预览的是哪个文件
- **修复**: 预览最后选中的文件
- ✅ 已修复

## 🚀 下一步优化建议

### 短期（可选）
- [ ] 添加选中项数量提示（如：已选中 3 个文件）
- [ ] 多选时在预览面板顶部显示"预览：xxx"
- [ ] 支持 Shift + 点击连续选择

### 中期（待定）
- [ ] 文件夹预览支持翻页（显示更多文件）
- [ ] 文件夹预览中的文件可以直接点击预览
- [ ] 添加键盘快捷键支持（方向键切换选中）

## ✅ 测试清单

- [x] 单击文件保持高亮
- [x] 单击文件显示预览
- [x] 单击文件夹显示文件夹列表
- [x] Ctrl + 点击多选工作正常
- [x] 从 PDF 切换到其他文件样式正常
- [x] 预览面板正确显示内容

## 📝 测试方法

1. **测试文件选中**：
   - 点击一个文件
   - 再次点击同一文件
   - 确认高亮不消失

2. **测试文件预览**：
   - 点击文本文件 → 查看预览
   - 点击图片文件 → 查看预览
   - 点击 PDF 文件 → 查看预览

3. **测试文件夹预览**：
   - 点击文件夹
   - 确认右侧显示文件夹内容列表

4. **测试多选**：
   - 点击文件 A
   - Ctrl + 点击文件 B
   - 确认两个文件都高亮
   - Ctrl + 点击 A
   - 确认 A 取消高亮，B 保持

---

**修复日期**: 2025-11-18  
**状态**: ✅ 已修复并测试  
**影响范围**: 文件选择、文件预览、文件夹预览  
**优先级**: 高

