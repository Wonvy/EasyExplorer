# 空格预览和驱动器过滤修复说明

## 更新时间
2025-01-17

## 修复内容

### 1. 空格键预览功能

**功能描述：**
选中单个文件后，按空格键可以在右侧预览面板快速预览文件内容，无需双击打开。

**实现代码：**
```javascript
// 添加空格键预览快捷键
document.addEventListener('keydown', async (e) => {
    // 空格键 - 预览选中的文件
    if (e.key === ' ' && selectedFiles.length === 1 && !e.ctrlKey && !e.shiftKey && !e.altKey) {
        e.preventDefault(); // 防止页面滚动
        const filePath = selectedFiles[0];
        await updatePreview(filePath);
        return;
    }
    // ... 其他快捷键
});
```

**功能特性：**
- ✅ 仅在选中单个文件时生效
- ✅ 防止空格键触发页面滚动
- ✅ 不与其他组合键冲突（Ctrl/Shift/Alt + Space）
- ✅ 支持所有可预览的文件类型（图片、视频、音频、文本等）
- ✅ 快速浏览文件内容，提高效率

**使用方法：**
1. 用鼠标或键盘选中一个文件
2. 按下空格键
3. 右侧预览面板自动显示文件内容
4. 可以使用方向键切换文件，每次按空格键更新预览

**支持的预览类型：**
- 📁 **文件夹**: 显示文件夹内容列表
- 🖼️ **图片**: 显示完整图片
- 🎬 **视频**: 嵌入式播放器
- 🎵 **音频**: 嵌入式播放器
- 📝 **文本/代码**: 语法高亮显示
- 📄 **PDF**: 显示文件信息和打开按钮
- 📦 **其他文件**: 显示文件信息

---

### 2. 过滤未知类型驱动器

**问题描述：**
某些虚拟驱动器或特殊设备可能被识别为"未知类型"，显示在驱动器列表中但无法正常使用。

**解决方案：**
在 Rust 后端直接过滤掉未知类型的驱动器，不返回给前端。

**实现代码：**
```rust
// 解析驱动器类型
let (drive_type, default_label) = match drive_type_num {
    "2" => ("Removable", "可移动磁盘"),
    "3" => ("HDD", "本地磁盘"),
    "4" => ("Network", "网络驱动器"),
    "5" => ("CD-ROM", "光盘驱动器"),
    _ => {
        // 跳过未知类型的驱动器
        continue;
    }
};
```

**效果：**
- ✅ 只显示可识别的驱动器类型
- ✅ 避免显示无法使用的驱动器
- ✅ 提高驱动器列表的可靠性
- ✅ 减少用户困惑

**已知的驱动器类型（DriveType）：**
| 类型值 | 类型名称 | 说明 |
|--------|----------|------|
| 2 | Removable | U盘、移动硬盘 |
| 3 | Local Disk | 本地磁盘（HDD/SSD） |
| 4 | Network | 网络映射驱动器 |
| 5 | CD-ROM | 光盘驱动器 |
| 其他 | Unknown | **已过滤，不显示** |

---

## 修复的错误

### 编译错误：缺少 sysinfo 依赖

**错误信息：**
```
error[E0432]: unresolved import `sysinfo`
 --> src\main.rs:7:5
  |
7 | use sysinfo::Disks;
  |     ^^^^^^^ use of undeclared crate `sysinfo`
```

**原因：**
`Cargo.toml` 中的 `sysinfo` 依赖丢失。

**解决方法：**
在 `src-tauri/Cargo.toml` 中重新添加依赖：
```toml
[dependencies]
sysinfo = "0.30"
```

---

## 键盘快捷键完整列表

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| **Space** | 预览文件 | 选中单个文件时预览 |
| Ctrl + C | 复制 | 复制选中的文件 |
| Ctrl + X | 剪切 | 剪切选中的文件 |
| Ctrl + V | 粘贴 | 粘贴文件到当前目录 |
| Delete | 删除 | 删除选中的文件 |
| F5 | 刷新 | 刷新当前目录 |
| Alt + ← | 后退 | 浏览历史后退 |
| Alt + → | 前进 | 浏览历史前进 |
| Alt + ↑ | 上一级 | 返回父目录 |
| Enter | 打开 | 打开文件/文件夹 |
| ↑ ↓ | 导航 | 选择文件 |

---

## 使用场景示例

### 场景1：快速浏览图片
1. 打开包含大量图片的文件夹
2. 使用方向键 ↓ 选择第一张图片
3. 按 **Space** 预览
4. 按 ↓ 选择下一张
5. 再按 **Space** 预览下一张
6. 快速浏览所有图片，无需逐个打开

### 场景2：查看代码文件
1. 选中一个 `.js` 文件
2. 按 **Space**
3. 在预览面板查看代码内容
4. 无需打开编辑器即可快速查看

### 场景3：检查文件夹内容
1. 选中一个文件夹
2. 按 **Space**
3. 预览面板显示文件夹内的前20个项目
4. 快速了解文件夹内容

---

## 测试清单

### 空格键预览
- [ ] 选中单个文件后按空格能显示预览
- [ ] 预览面板自动滚动到顶部
- [ ] 按空格不会触发页面滚动
- [ ] 多选文件时按空格不响应
- [ ] 未选中文件时按空格不响应
- [ ] Ctrl/Shift/Alt + Space 不触发预览

### 驱动器过滤
- [ ] 只显示可识别的驱动器类型
- [ ] 本地磁盘正常显示
- [ ] 网络驱动器正常显示
- [ ] U盘插入后正常显示
- [ ] 光驱（如果有）正常显示
- [ ] 未知类型的驱动器不显示

### 预览类型
- [ ] 图片文件预览正常
- [ ] 视频文件可以播放
- [ ] 音频文件可以播放
- [ ] 文本文件显示内容
- [ ] 代码文件显示内容
- [ ] 文件夹显示项目列表
- [ ] PDF 显示信息和打开按钮

---

## 兼容性说明

### 空格键预览
- ✅ **Windows**: 完全支持
- ✅ **Linux**: 完全支持
- ✅ **macOS**: 完全支持（类似 Quick Look 功能）

### 驱动器类型检测
- ✅ **Windows**: 使用 wmic，完全支持
- ⚠️ **Linux**: 使用 sysinfo，支持有限
- ⚠️ **macOS**: 使用 sysinfo，支持有限

---

## 后续优化建议

### 空格键预览增强
1. **全屏预览模式**:
   - 按 Space 进入快速预览
   - 再按 Space 进入全屏预览
   - Esc 退出全屏

2. **幻灯片模式**:
   - 在预览状态下使用方向键自动切换文件
   - 自动播放功能

3. **预览缓存**:
   - 缓存已预览的内容
   - 提高切换速度

4. **预览加载指示**:
   - 大文件加载时显示进度
   - 加载失败时显示友好提示

### 驱动器管理增强
1. **驱动器分组**:
   - 本地驱动器
   - 网络驱动器
   - 可移动设备

2. **驱动器状态**:
   - 实时监控在线/离线状态
   - 显示不同的图标或颜色

3. **驱动器操作**:
   - 右键菜单支持弹出设备
   - 断开网络驱动器
   - 查看驱动器属性

---

## 故障排除

### 问题1：按空格键没反应

**可能原因：**
- 没有选中文件
- 选中了多个文件
- 输入焦点在其他元素上

**解决方法：**
1. 确保只选中一个文件
2. 点击文件列表区域确保焦点正确
3. 尝试先点击文件再按空格

### 问题2：某些驱动器不显示

**可能原因：**
- 驱动器类型未知被过滤
- 驱动器没有正确挂载
- 权限不足

**解决方法：**
1. 在"此电脑"中确认驱动器是否可见
2. 检查驱动器是否正确挂载
3. 以管理员权限运行应用（如果需要）

### 问题3：编译错误

**错误信息：** `unresolved import sysinfo`

**解决方法：**
确保 `src-tauri/Cargo.toml` 包含：
```toml
[dependencies]
sysinfo = "0.30"
```

然后运行：
```bash
npm run dev
```

---

## 技术实现细节

### 事件优先级
空格键预览的优先级设置：
1. 首先检查是否有修饰键（Ctrl/Shift/Alt）
2. 检查是否选中单个文件
3. 阻止默认行为（页面滚动）
4. 调用预览函数

### 性能优化
- 使用 `e.preventDefault()` 防止不必要的页面操作
- 异步加载预览内容，不阻塞UI
- 大文件自动截断，避免内存溢出

---

## 相关文档
- [工具栏按钮修复说明.md](./工具栏按钮修复说明.md)
- [文件预览功能说明.md](./功能修复和增强说明.md)
- [驱动器显示修复说明.md](./驱动器显示修复说明.md)





