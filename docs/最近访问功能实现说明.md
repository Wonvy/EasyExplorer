# 最近访问功能实现说明

## 更新时间
2025-01-17

## 功能概述

实现了"最近"标签页，显示用户最近访问的文件和文件夹，按时间分组展示，提供快速访问入口。

---

## 实现的功能

### 1. 访问记录追踪
- ✅ 自动记录打开的文件和文件夹
- ✅ 存储访问时间戳
- ✅ 最多保存 50 条记录
- ✅ 去重处理（同一路径只保留最新访问记录）

### 2. 时间分组显示
- **今天** - 当天访问的文件
- **昨天** - 昨天访问的文件
- **本周** - 本周内访问的文件
- **更早** - 更早之前访问的文件

### 3. 交互功能
- **单击**：
  - 文件夹：切换到主页标签并导航到该文件夹
  - 文件：在预览面板中显示预览
- **双击**：
  - 文件夹：导航并打开
  - 文件：用默认程序打开
- **右键菜单**：
  - 打开
  - 在文件资源管理器中显示
  - 从列表中移除

### 4. 路径验证
- 自动检查记录的路径是否仍然存在
- 移除已不存在的文件/文件夹
- 确保列表始终有效

---

## 修改的文件

### 1. `src/renderer-tauri.js`

#### 添加访问记录变量（第 35-59 行）
```javascript
// 最近访问记录
let recentAccess = JSON.parse(localStorage.getItem('recentAccess')) || [];

// 添加到最近访问记录
function addToRecentAccess(filePath, isDirectory) {
    // 移除已存在的相同路径
    recentAccess = recentAccess.filter(item => item.path !== filePath);
    
    // 添加到开头
    recentAccess.unshift({
        path: filePath,
        name: path.basename(filePath),
        isDirectory: isDirectory,
        accessTime: Date.now()
    });
    
    // 限制最多保存 50 条记录
    if (recentAccess.length > 50) {
        recentAccess = recentAccess.slice(0, 50);
    }
    
    // 保存到 localStorage
    localStorage.setItem('recentAccess', JSON.stringify(recentAccess));
}
```

#### 在导航时记录访问（第 379 行）
```javascript
// navigateTo 函数中
currentPath = normalizedPath;

// 记录访问历史
addToRecentAccess(normalizedPath, true);
```

#### 在打开文件时记录访问（第 784 行）
```javascript
// openFile 函数中
else {
    try {
        // 记录文件访问
        addToRecentAccess(file.path, false);
        await invoke('open_with_default', { path: file.path });
    }
}
```

#### 标签切换时加载最近访问（第 1157-1159 行）
```javascript
// 如果是最近访问标签，刷新内容
if (targetTab === 'recent') {
    loadRecentAccess();
}
```

#### 最近访问显示逻辑（第 2846-3104 行）

**核心函数：**

1. **`loadRecentAccess()`** - 加载和显示最近访问列表
   - 验证路径有效性
   - 按日期分组
   - 生成 HTML
   - 绑定事件

2. **`showRecentContextMenu()`** - 显示右键菜单
   - 打开文件/文件夹
   - 在资源管理器中显示
   - 从列表中移除

**关键代码片段：**
```javascript
async function loadRecentAccess() {
    const recentTab = document.getElementById('recent-tab');
    if (!recentTab) return;
    
    // 过滤掉不存在的文件/文件夹
    const validRecent = [];
    for (const item of recentAccess) {
        try {
            const exists = await invoke('path_exists', { path: item.path });
            if (exists) {
                validRecent.push(item);
            }
        } catch (err) {
            console.warn(`检查路径失败: ${item.path}`, err);
        }
    }
    
    // 按日期分组
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const thisWeek = new Date(today);
    thisWeek.setDate(thisWeek.getDate() - 7);
    
    const groups = {
        today: [],
        yesterday: [],
        thisWeek: [],
        older: []
    };
    
    // 分组逻辑...
}
```

---

### 2. `src/scss/components/_recent.sass`

**新建文件**，包含最近访问的完整样式。

#### 主要样式

**空状态样式：**
```sass
.recent-empty
  display: flex
  flex-direction: column
  align-items: center
  justify-content: center
  height: 100%
  text-align: center
  padding: 40px 20px
```

**分组样式：**
```sass
.recent-group
  margin-bottom: 20px

  .recent-group-header
    display: flex
    align-items: center
    padding: 8px 10px
    cursor: pointer
    border-radius: 4px
    transition: background-color 0.2s
    font-weight: 500
    font-size: 13px

    &:hover
      background-color: rgba(0, 0, 0, 0.05)
```

**项目样式：**
```sass
.recent-item
  display: flex
  align-items: center
  padding: 10px 12px
  margin: 2px 0
  cursor: pointer
  border-radius: 6px
  transition: all 0.2s
  gap: 10px

  &:hover
    background-color: rgba(74, 144, 226, 0.08)
    transform: translateX(2px)

  .recent-item-icon
    flex-shrink: 0
    width: 24px
    height: 24px

  .recent-item-info
    flex: 1
    min-width: 0

    .recent-item-name
      font-size: 13px
      font-weight: 500
      color: #333
      white-space: nowrap
      overflow: hidden
      text-overflow: ellipsis

    .recent-item-path
      font-size: 11px
      color: #999
      white-space: nowrap
      overflow: hidden
      text-overflow: ellipsis

  .recent-item-time
    flex-shrink: 0
    font-size: 11px
    color: #999
```

---

### 3. `src/scss/styles.sass`

添加导入语句（第 10 行）：
```sass
@use 'components/_recent'
```

---

### 4. `src-tauri/Cargo.toml`

添加 `sysinfo` 依赖（第 20 行）：
```toml
sysinfo = "0.30"
```

---

## 数据结构

### recentAccess 数组格式

```javascript
[
  {
    path: "C:\\Users\\Username\\Documents\\file.txt",
    name: "file.txt",
    isDirectory: false,
    accessTime: 1705478400000  // Unix timestamp (ms)
  },
  {
    path: "C:\\Users\\Username\\Projects",
    name: "Projects",
    isDirectory: true,
    accessTime: 1705478350000
  }
]
```

**字段说明：**
- `path`: 文件或文件夹的完整路径
- `name`: 文件或文件夹名称
- `isDirectory`: 是否为目录
- `accessTime`: 访问时间戳（毫秒）

---

## 使用流程

### 1. 正常使用即可自动记录

```
用户操作 → 访问文件/文件夹
    ↓
navigateTo() / openFile()
    ↓
addToRecentAccess()
    ↓
存储到 localStorage
```

### 2. 查看最近访问

```
点击"最近"标签
    ↓
loadRecentAccess()
    ↓
验证路径有效性
    ↓
按日期分组
    ↓
显示列表
```

### 3. 与最近项目交互

```
单击文件夹 → 切换到主页 → 导航到该文件夹
单击文件 → 在预览面板显示
双击 → 打开文件/文件夹
右键 → 显示上下文菜单
```

---

## UI 设计

### 布局结构

```
┌─────────────────────────────────────┐
│ 最近访问                             │
├─────────────────────────────────────┤
│ ▼ 今天 (3)                          │
│   📄 document.pdf      14:25        │
│   📁 Projects          13:45        │
│   📷 photo.jpg         10:30        │
│                                      │
│ ▼ 昨天 (2)                          │
│   📄 report.docx       18:20        │
│   📁 Downloads         15:10        │
│                                      │
│ ▼ 本周 (5)                          │
│   ...                                │
│                                      │
│ ▼ 更早 (12)                         │
│   ...                                │
└─────────────────────────────────────┘
```

### 空状态

```
┌─────────────────────────────────────┐
│                                      │
│          🕐                          │
│                                      │
│   暂无最近访问的文件和文件夹        │
│   打开文件或文件夹后会显示在这里    │
│                                      │
└─────────────────────────────────────┘
```

---

## 特性

### 1. 智能去重
- 同一文件/文件夹多次访问时，只保留最新的一条记录
- 避免列表中出现重复项

### 2. 容量限制
- 最多保存 50 条记录
- 超出限制时自动删除最旧的记录
- 平衡存储空间和实用性

### 3. 自动清理
- 每次打开"最近"标签时验证路径
- 自动移除已删除的文件/文件夹
- 保持列表的有效性

### 4. 分组折叠
- 每个时间分组可以独立展开/折叠
- 点击分组标题切换状态
- 图标旋转动画提示状态

---

## 测试清单

### 功能测试
- [ ] 打开文件夹后记录被添加到"最近"
- [ ] 打开文件后记录被添加到"最近"
- [ ] 同一项目多次访问只保留最新记录
- [ ] 记录数超过 50 条时自动删除旧记录
- [ ] 切换到"最近"标签正确显示列表
- [ ] 路径不存在的记录被自动移除

### 交互测试
- [ ] 单击文件夹切换到主页并导航
- [ ] 单击文件在预览面板显示
- [ ] 双击文件夹正确导航
- [ ] 双击文件用默认程序打开
- [ ] 右键菜单正确显示
- [ ] "从列表中移除"功能正常

### 分组测试
- [ ] "今天"分组包含当天访问的项目
- [ ] "昨天"分组包含昨天访问的项目
- [ ] "本周"分组包含本周访问的项目
- [ ] "更早"分组包含更早访问的项目
- [ ] 分组标题显示正确的项目数量
- [ ] 点击分组标题可以展开/折叠

### 样式测试
- [ ] 列表项悬停效果正常
- [ ] 图标显示正确（文件夹/文件类型）
- [ ] 时间显示格式正确
- [ ] 路径显示且正确截断
- [ ] 空状态显示正确
- [ ] 亮色/暗色主题都正常

---

## 性能考虑

### 存储优化
- 使用 `localStorage` 存储，无需服务器
- JSON 序列化轻量高效
- 限制记录数量控制存储大小

### 查询优化
- 路径验证使用并发异步调用
- 分组计算在内存中完成
- 避免不必要的 DOM 操作

### 渲染优化
- 一次性生成完整 HTML
- 使用事件委托减少监听器数量
- CSS 过渡动画使用 GPU 加速

---

## 已知限制

### 1. 跨设备不同步
- 记录存储在本地
- 不同设备有独立的记录
- 不支持云同步

### 2. 路径变更不追踪
- 文件/文件夹移动或重命名后记录失效
- 需要重新访问才能更新

### 3. 隐私考虑
- 所有访问记录明文存储在 `localStorage`
- 可以被其他脚本读取
- 建议敏感文件使用后手动移除

---

## 未来改进建议

### 1. 高级过滤
- 按文件类型过滤
- 按路径搜索
- 收藏常用项目

### 2. 统计功能
- 访问频率统计
- 最常访问的文件夹
- 访问热力图

### 3. 导出/导入
- 导出访问历史
- 备份和恢复
- 跨设备迁移

### 4. 隐私模式
- 隐私浏览模式不记录
- 一键清除历史
- 黑名单路径过滤

---

## 故障排除

### 问题1：点击"最近"标签无内容

**可能原因：**
- 还没有访问过任何文件/文件夹
- `localStorage` 被清除
- `recentAccess` 数组为空

**解决方法：**
1. 打开一些文件或文件夹
2. 刷新"最近"标签
3. 检查浏览器控制台是否有错误

---

### 问题2：某些记录不显示

**可能原因：**
- 文件/文件夹已被删除
- 路径验证失败
- 权限问题

**解决方法：**
1. 检查文件/文件夹是否仍然存在
2. 确认有读取权限
3. 查看控制台警告信息

---

### 问题3：时间分组不正确

**可能原因：**
- 系统时间不正确
- 时区问题
- 时间戳格式错误

**解决方法：**
1. 检查系统时间设置
2. 确认时区正确
3. 清除并重新生成记录

---

## 相关文档
- [选中状态和空格预览修复](./选中状态和空格预览修复.md)
- [侧边栏样式文档](../src/scss/components/_sidebar.sass)
- [驱动器布局优化](./驱动器布局优化-卷标盘符同行.md)

---

## 附加说明

### 驱动器显示格式优化

在此次更新中，同时优化了驱动器的显示格式：

**优化前：**
```
本地磁盘 (C:)          C:\
50GB 可用 / 100GB
```

**优化后：**
```
本地磁盘 (C:) (C:\)
50GB 可用 / 100GB
```

**变更：**
- 卷标和盘符显示在同一行
- 盘符用括号包裹，作为卷标的补充信息
- 第二行显示容量信息
- 更紧凑、更直观的布局

---

## 修改历史

| 日期 | 版本 | 修改内容 | 修改人 |
|------|------|---------|--------|
| 2025-01-17 | 1.0.0 | 实现最近访问功能 | AI Assistant |
| 2025-01-17 | 1.0.1 | 优化驱动器显示格式 | AI Assistant |





